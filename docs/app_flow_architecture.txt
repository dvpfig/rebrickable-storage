================================================================================
APPLICATION EXECUTION FLOW
================================================================================

â”Œâ”€ app.py (Main Entry Point)
â”‚
â”œâ”€â”¬â”€ CORE MODULES
â”‚ â”œâ”€ core/auth/
â”‚     â”œâ”€ api_keys.py
â”‚    â”‚    â””â”€ save_api_key(user_data_dir, api_key)
â”‚    â”‚    â””â”€ load_api_key(user_data_dir)
â”‚    â”‚    â””â”€ delete_api_key(user_data_dir)
â”‚     â”œâ”€ auth.py
â”‚    â”‚    â””â”€ __init__(self, config_path, audit_log_dir)
â”‚    â”‚    â””â”€ _create_default_config(self)
â”‚    â”‚    â””â”€ check_session_timeout(self, username)
â”‚     â””â”€ security.py
â”‚         â””â”€ _detect_image_type(file_bytes)
â”‚         â””â”€ setup_audit_logger(log_dir)
â”‚         â””â”€ sanitize_html(text)
â”‚ â”œâ”€ core/data/
â”‚     â”œâ”€ color_similarity.py
â”‚    â”‚    â””â”€ rgb_to_lab(rgb_hex)
â”‚    â”‚    â””â”€ calculate_color_distance(color1_rgb, color2_rgb, is_trans1, ...)
â”‚    â”‚    â””â”€ build_color_similarity_matrix(colors_df)
â”‚     â”œâ”€ colors.py
â”‚    â”‚    â””â”€ load_colors(colors_path)
â”‚    â”‚    â””â”€ build_color_lookup(colors_df)
â”‚    â”‚    â””â”€ render_color_cell(color_id, color_lookup)
â”‚     â”œâ”€ preprocess.py
â”‚    â”‚    â””â”€ sanitize_and_validate(df, required, label)
â”‚    â”‚    â””â”€ load_wanted_files(files)
â”‚    â”‚    â””â”€ load_collection_files(files)
â”‚     â””â”€ sets.py
â”‚         â””â”€ __init__(self, user_data_dir, global_cache_dir, ...)
â”‚         â””â”€ load_sets_from_csv(self, csv_file, source_name)
â”‚         â””â”€ _parse_bool(self, value)
â”‚ â”œâ”€ core/external/
â”‚     â”œâ”€ download_helpers.py
â”‚    â”‚    â””â”€ create_download_callbacks(stop_flag_key, show_stats, stats_formatter)
â”‚    â”‚    â””â”€ __init__(self, stop_flag_key, show_stats, ...)
â”‚    â”‚    â””â”€ progress_callback(self, message, status)
â”‚     â””â”€ rebrickable_api.py
â”‚         â””â”€ __init__(self, api_key, timeout)
â”‚         â””â”€ validate_key(self)
â”‚         â””â”€ get_set_parts(self, set_number, include_spares)
â”‚ â”œâ”€ core/infrastructure/
â”‚     â”œâ”€ paths.py
â”‚    â”‚    â””â”€ init_paths()
â”‚    â”‚    â””â”€ save_uploadedfiles(uploadedfiles_list, user_collection_dir)
â”‚    â”‚    â””â”€ manage_default_collection(user_collection_dir)
â”‚     â””â”€ session.py
â”‚         â””â”€ ensure_session_state_keys()
â”‚         â””â”€ short_key()
â”‚ â”œâ”€ core/labels/
â”‚     â”œâ”€ labels.py
â”‚    â”‚    â””â”€ organize_labels_by_location(collection_df, ba_mapping, labels_source_dir, ...)
â”‚    â”‚    â””â”€ generate_collection_labels_zip(collection_files_stream, ba_mapping, labels_source_dir, ...)
â”‚     â””â”€ lbx_merger.py
â”‚         â””â”€ main()
â”‚         â””â”€ __init__(self, max_length_mm, spacing_mm)
â”‚         â””â”€ parse_label_xml(self, xml)
â”‚ â”œâ”€ core/parts/
â”‚     â”œâ”€ custom_mapping.py
â”‚    â”‚    â””â”€ create_default_custom_mapping_csv(csv_path)
â”‚    â”‚    â””â”€ load_custom_mapping_csv(csv_path)
â”‚    â”‚    â””â”€ save_custom_mapping_csv(df, csv_path)
â”‚     â”œâ”€ images.py
â”‚    â”‚    â””â”€ _get_unavailable_images_file(user_data_dir)
â”‚    â”‚    â””â”€ _load_unavailable_images(user_data_dir)
â”‚    â”‚    â””â”€ _save_unavailable_images(unavailable_images, user_data_dir)
â”‚     â””â”€ mapping.py
â”‚         â””â”€ read_ba_mapping_from_excel_bytes(excel_bytes)
â”‚         â””â”€ load_ba_part_names(mapping_path)
â”‚         â””â”€ load_ba_mapping(mapping_path, custom_mapping_path)
â”‚ â””â”€ core/state/
      â”œâ”€ find_wanted_parts.py
     â”‚    â””â”€ get_unfound_parts(merged_df, color_lookup)
     â”‚    â””â”€ merge_set_results(original_df, set_results)
     â”‚    â””â”€ render_missing_parts_by_set(set_results, merged_df, part_images_map, ...)
      â””â”€ progress.py
          â””â”€ render_summary_table(merged_df, set_search_results, set_found_counts, ...)
â”‚
â”œâ”€â”¬â”€ UI MODULES
â”‚ â”œâ”€ ui/shared_content.py
â”‚     â””â”€ render_about_info_content()
â”‚     â””â”€ render_app_features_content()
â”‚     â””â”€ render_new_user_content()
â”‚ â””â”€ ui/theme.py
      â””â”€ apply_custom_styles()
â”‚
â”œâ”€â”¬â”€ PAGES
â”‚ â”œâ”€ pages/1_Rebrickable_Storage.py
â”‚     â””â”€ 90 lines of code
â”‚ â”œâ”€ pages/2_My_Collection_Parts.py
â”‚     â””â”€ 697 lines of code
â”‚ â”œâ”€ pages/3_My_Collection_Sets.py
â”‚     â””â”€ 403 lines of code
â”‚ â””â”€ pages/4_Find_Wanted_Parts.py
      â””â”€ 351 lines of code
â”‚
â””â”€â”¬â”€ RESOURCES
  â”œâ”€ auth_config.yaml (User credentials)
  â”œâ”€ colors.csv (LEGO color database)
  â””â”€ part number mapping.xlsx (BA â†” RB)

================================================================================
USER EXPERIENCE FLOW
================================================================================

â”Œâ”€ 1. LOGIN
â”‚  â”œâ”€ User enters credentials
â”‚  â”œâ”€ AuthManager.login() validates
â”‚  â”œâ”€ Session initialized
â”‚  â””â”€ Redirect to main app
â”‚
â–¼
â”‚
â”Œâ”€ 2. UPLOAD WANTED PARTS
â”‚  â”œâ”€ File uploader widget
â”‚  â”œâ”€ CSV validation
â”‚  â”œâ”€ Store in session_state['wanted_df']
â”‚  â””â”€ Display preview
â”‚
â–¼
â”‚
â”Œâ”€ 3. SELECT COLLECTION
â”‚  â”œâ”€ List available collection files
â”‚  â”œâ”€ User selects files
â”‚  â”œâ”€ Load CSVs into session_state['collection_df']
â”‚  â””â”€ Merge collections
â”‚
â–¼
â”‚
â”Œâ”€ 4. PROCESS & MATCH
â”‚  â”œâ”€ preprocess.merge_wanted_collection()
â”‚  â”œâ”€ mapping.apply_part_mappings()
â”‚  â”œâ”€ images.fetch_images()
â”‚  â”œâ”€ colors.add_color_data()
â”‚  â””â”€ Group by location
â”‚
â–¼
â”‚
â”Œâ”€ 5. BROWSE LOCATIONS
â”‚  â”œâ”€ Display location cards
â”‚  â”œâ”€ Show part images
â”‚  â”œâ”€ Display quantities needed/available
â”‚  â””â”€ Expandable details
â”‚
â–¼
â”‚
â”Œâ”€ 6. MARK FOUND PARTS
â”‚  â”œâ”€ User clicks 'Found' button
â”‚  â”œâ”€ Update session_state['found_counts']
â”‚  â”œâ”€ Recalculate remaining
â”‚  â””â”€ Visual feedback
â”‚
â–¼
â”‚
â”Œâ”€ 7. EXPORT RESULTS
â”‚  â”œâ”€ Download merged CSV
â”‚  â”œâ”€ Generate location labels
â”‚  â”œâ”€ Create LBX file
â”‚  â””â”€ Save session progress
â”‚

================================================================================
MULTI-PAGE NAVIGATION STRUCTURE
================================================================================

â”Œâ”€ app.py (Main Entry Point)
â”‚
â”œâ”€ Authentication & Setup
â”‚  â”œâ”€ Login/Register
â”‚  â”œâ”€ Session State Initialization
â”‚  â””â”€ Path Resolution
â”‚
â”œâ”€ Sidebar Features (Global)
â”‚  â”œâ”€ User Profile & Logout
â”‚  â”œâ”€ Get Latest Labels/Images from BrickArchitect
â”‚  â””â”€ Sync Latest Parts Mappings
â”‚
â””â”€â”¬â”€ MULTI-PAGE NAVIGATION
  â”‚
  â”œâ”€ 1_Rebrickable_Storage
  â”‚    â””â”€ 1_Rebrickable_Storage
  â”‚       â”œâ”€ 90 lines of code
  â”‚       â”œâ”€ 1 core module imports
  â”‚       â””â”€ 5 UI elements
  â”œâ”€ 2_My_Collection_Parts
  â”‚    â””â”€ ğŸ·ï¸ My Collection - Parts
  â”‚       â”œâ”€ 697 lines of code
  â”‚       â”œâ”€ 15 core module imports
  â”‚       â””â”€ 46 UI elements
  â”œâ”€ 3_My_Collection_Sets
  â”‚    â””â”€ ğŸ“¦ My Collection - Sets
  â”‚       â”œâ”€ 403 lines of code
  â”‚       â”œâ”€ 4 core module imports
  â”‚       â””â”€ 30 UI elements
  â””â”€ 4_Find_Wanted_Parts
       â””â”€ ğŸ” Find Wanted Parts
          â”œâ”€ 351 lines of code
          â”œâ”€ 12 core module imports
          â””â”€ 12 UI elements

================================================================================
PAGE NAVIGATION FLOW
================================================================================

â”Œâ”€ 1. Landing Page (app.py)
â”‚  â”œâ”€ User logs in or registers
â”‚  â”œâ”€ Sees welcome screen with navigation options
â”‚  â””â”€ Session state initialized, sets data loaded
â”‚
â–¼
â”‚
â”Œâ”€ 2. Rebrickable Storage (1_Rebrickable_Storage.py)
â”‚  â”œâ”€ Main dashboard and getting started page
â”‚  â”œâ”€ Overview of available functions
â”‚  â””â”€ Navigation to other pages
â”‚
â–¼
â”‚
â”Œâ”€ 3. My Collection - Parts (2_My_Collection_Parts.py)
â”‚  â”œâ”€ Manage collection files (upload, select, delete)
â”‚  â”œâ”€ Generate printable labels by location (LBX + merged)
â”‚  â”œâ”€ Manage custom part images (upload, export, delete)
â”‚  â”œâ”€ Sync BrickArchitect labels and images
â”‚  â””â”€ View collection statistics
â”‚
â–¼
â”‚
â”Œâ”€ 4. My Collection - Sets (3_My_Collection_Sets.py)
â”‚  â”œâ”€ Upload sets CSV or add manually
â”‚  â”œâ”€ Configure Rebrickable API key
â”‚  â”œâ”€ Retrieve part inventories (single or batch)
â”‚  â”œâ”€ Delete sets or source groups
â”‚  â””â”€ View sets grouped by source
â”‚
â–¼
â”‚
â”Œâ”€ 5. Find Wanted Parts (4_Find_Wanted_Parts.py)
â”‚  â”œâ”€ Upload wanted parts lists
â”‚  â”œâ”€ Select collection files to search
â”‚  â”œâ”€ Generate pickup list by location
â”‚  â”œâ”€ Search owned sets for missing parts
â”‚  â”œâ”€ Mark parts as found (per-location mark all/clear)
â”‚  â”œâ”€ View color alternatives
â”‚  â”œâ”€ View progress summary table
â”‚  â”œâ”€ Save/load progress
â”‚  â””â”€ Download merged results or missing parts export
â”‚

================================================================================
FUNCTION DISTRIBUTION ANALYSIS
================================================================================

â”Œâ”€ FUNCTION DISTRIBUTION BY MODULE TYPE
â”‚
â”‚  Core Modules:      0 functions
â”‚  UI Modules:        0 functions
â”‚  Resource Modules:  0 functions
â”‚  Main App:          0 functions
â”‚
â”œâ”€ PAGE COMPLEXITY METRICS
â”‚
â”‚  â”œâ”€ 1_Rebrickable_Storage
â”‚  â”‚     â”œâ”€ 90 lines of code
â”‚  â”‚     â”œâ”€ 1 core module imports
â”‚  â”‚     â””â”€ 5 UI elements
â”‚  â”œâ”€ 2_My_Collection_Parts
â”‚  â”‚     â”œâ”€ 697 lines of code
â”‚  â”‚     â”œâ”€ 15 core module imports
â”‚  â”‚     â””â”€ 46 UI elements
â”‚  â”œâ”€ 3_My_Collection_Sets
â”‚  â”‚     â”œâ”€ 403 lines of code
â”‚  â”‚     â”œâ”€ 4 core module imports
â”‚  â”‚     â””â”€ 30 UI elements
â”‚  â””â”€ 4_Find_Wanted_Parts
â”‚        â”œâ”€ 351 lines of code
â”‚        â”œâ”€ 12 core module imports
â”‚        â””â”€ 12 UI elements
â”‚
â””â”€ ARCHITECTURE PATTERN

   The application follows a modular architecture:
   â”œâ”€ Core modules contain business logic (reusable)
   â”œâ”€ UI modules contain presentation helpers (reusable)
   â”œâ”€ Pages contain page-specific UI logic (minimal functions)
   â””â”€ Main app handles authentication and global setup

   This separation ensures:
   â€¢ Business logic is testable and reusable
   â€¢ Pages remain focused on user interaction
   â€¢ Code is maintainable and scalable

================================================================================
DATA STRUCTURES & DIMENSIONS
================================================================================

â”Œâ”€ SESSION STATE (st.session_state)
â”‚
â”‚  â”œâ”€ wanted_df: DataFrame
â”‚  â”‚     â””â”€ Wanted parts list
â”‚  â”‚        â””â”€ Columns: Part, Color, Quantity, Location
â”‚  â”œâ”€ collection_df: DataFrame
â”‚  â”‚     â””â”€ User's collection
â”‚  â”‚        â””â”€ Columns: Part, Color, Quantity, Location
â”‚  â”œâ”€ merged_df: DataFrame
â”‚  â”‚     â””â”€ Matched parts
â”‚  â”‚        â””â”€ wanted_df + collection_df merged
â”‚  â”œâ”€ found_counts: Dict
â”‚  â”‚     â””â”€ Tracking found parts
â”‚  â”‚        â””â”€ {(part, color, location): count}
â”‚  â”œâ”€ locations_index: Dict
â”‚  â”‚     â””â”€ Location grouping
â”‚  â”‚        â””â”€ {location: [image_urls]}
â”‚  â”œâ”€ expanded_loc: str
â”‚  â”‚     â””â”€ UI state
â”‚  â”‚        â””â”€ Currently expanded location
â”‚  â”œâ”€ start_processing: bool
â”‚  â”‚     â””â”€ Trigger flag
â”‚  â”‚        â””â”€ Initiates processing
â”‚  â””â”€ theme: str
â”‚        â””â”€ UI preference
â”‚           â””â”€ 'dark' or 'light'
â”‚
â”œâ”€ DATAFRAMES
â”‚
â”‚  â”œâ”€ wanted_df
â”‚  â”‚     â”œâ”€ Part Number (str)
â”‚  â”‚     â”œâ”€ Color (str)
â”‚  â”‚     â”œâ”€ Quantity Needed (int)
â”‚  â”‚     â””â”€ Location (str, optional)
â”‚  â”œâ”€ collection_df
â”‚  â”‚     â”œâ”€ Part Number (str)
â”‚  â”‚     â”œâ”€ Color (str)
â”‚  â”‚     â”œâ”€ Quantity Available (int)
â”‚  â”‚     â””â”€ Location (str)
â”‚  â””â”€ merged_df
â”‚        â”œâ”€ Part Number (str)
â”‚        â”œâ”€ Color (str)
â”‚        â”œâ”€ Quantity Needed (int)
â”‚        â”œâ”€ Quantity Available (int)
â”‚        â”œâ”€ Location (str)
â”‚        â”œâ”€ Image URL (str)
â”‚        â”œâ”€ Color Name (str)
â”‚        â””â”€ Color RGB (str)
â”‚
â””â”€ FILE SYSTEM

   â”œâ”€ user_data/{username}/
   â”‚     â”œâ”€ collection/*.csv - User's collection files
   â”‚     â””â”€ session_data.json - Saved progress
   â”œâ”€ cache/
   â”‚     â”œâ”€ images/*.png - Cached part images
   â”‚     â””â”€ labels/*.png - Generated label images
   â””â”€ resources/
         â”œâ”€ auth_config.yaml - User credentials (hashed)
         â”œâ”€ colors.csv - LEGO color database (~200 colors)
         â””â”€ part number mapping.xlsx - BAâ†”RB mappings (~2000 parts)

================================================================================
MODULE DEPENDENCIES
================================================================================

app.py
â”‚
â”œâ”€ auth
â”‚    â””â”€ â†’ core.auth.security
â”œâ”€ find_wanted_parts
â”‚    â”œâ”€ â†’ core.data.colors
â”‚    â”œâ”€ â†’ core.infrastructure.session
â”‚    â””â”€ â†’ core.parts.images
â”œâ”€ images
â”‚    â”œâ”€ â†’ core.auth.security
â”‚    â”œâ”€ â†’ core.external.rebrickable_api
â”‚    â””â”€ â†’ core.security.validate_image_file
â”œâ”€ labels
â”‚    â”œâ”€ â†’ core.data.preprocess
â”‚    â””â”€ â†’ core.labels.lbx_merger
â”œâ”€ mapping
â”‚    â””â”€ â†’ core.parts.custom_mapping
â””â”€ sets
     â””â”€ â†’ core.external.rebrickable_api

================================================================================
ARCHITECTURE OVERVIEW
================================================================================

â”Œâ”€ TECHNOLOGY STACK
â”‚
â”‚  Frontend
â”‚  â””â”€ Streamlit (Web UI Framework)
â”‚
â”‚  Authentication
â”‚  â”œâ”€ streamlit-authenticator (Auth library)
â”‚  â”œâ”€ bcrypt (Password hashing)
â”‚  â””â”€ PyYAML (Config management)
â”‚
â”‚  Data Processing
â”‚  â”œâ”€ pandas (Data manipulation)
â”‚  â””â”€ requests (HTTP client)
â”‚
â”‚  Storage
â”‚  â”œâ”€ Local filesystem (Development)
â”‚  â””â”€ JSON (Session serialization)
â”‚
â”œâ”€ SESSION STATE MANAGEMENT
â”‚
â”‚  Global (Shared)
â”‚  â”œâ”€ ba_mapping - Part number mappings
â”‚  â”œâ”€ color_lookup - Color database
â”‚  â””â”€ theme - UI theme preference
â”‚
â”‚  User-Specific (Isolated)
â”‚  â”œâ”€ username - Current user
â”‚  â”œâ”€ authenticated - Auth status
â”‚  â”œâ”€ collection_df - User's collection
â”‚  â”œâ”€ found_counts - Parts marked as found
â”‚  â”œâ”€ locations_index - Location grouping
â”‚  â”œâ”€ merged_df - Matched parts
â”‚  â”œâ”€ sets_metadata - Sets collection data
â”‚  â”œâ”€ sets_inventories_cache - Cached inventories
â”‚  â”œâ”€ set_search_results - Set search results
â”‚  â””â”€ set_found_counts - Set-based found counts
â”‚
â”œâ”€ EXTERNAL INTEGRATIONS
â”‚
â”‚  â”Œâ”€ Rebrickable API
â”‚  â”‚  â””â”€ Part data and mappings
â”‚  â”‚
â”‚  â””â”€ BrickArchitect Images
â”‚     â””â”€ Part images (cached locally)
â”‚
â””â”€ DEPLOYMENT

   Development:
   â”œâ”€ localhost:8501
   â”œâ”€ File-based storage
   â”œâ”€ Local user_data/
   â””â”€ YAML configuration

   Production (Recommended):
   â”œâ”€ HTTPS with SSL/TLS
   â”œâ”€ Database backend (PostgreSQL/MongoDB)
   â”œâ”€ Cloud storage (S3/Azure Blob)
   â””â”€ Environment secrets management

================================================================================
RUNTIME METRICS & DATA DIMENSIONS
================================================================================

â”Œâ”€ RESOURCE DATA
â”‚
â”‚  Colors Database:
â”‚  â”œâ”€ Rows: 273
â”‚  â””â”€ Columns: 8
â”‚
â”‚  Part Mappings (BA â†” RB): base_part_mapping_2026-02-13.xlsx
â”‚  â”œâ”€ Rows: 4446
â”‚  â””â”€ Columns: 84
â”‚
â”‚  Custom Mappings: 13 rules
â”‚
â”œâ”€ CACHE DATA
â”‚
â”‚  â”œâ”€ BrickArchitect images: 1716
â”‚  â”œâ”€ Rebrickable images: 937
â”‚  â”œâ”€ Label files: 4113
â”‚  â””â”€ Set inventories: 19
â”‚
â”œâ”€ CORE MODULE DISTRIBUTION
â”‚
â”‚  â”œâ”€ core/auth/: 3 module(s)
â”‚  â”œâ”€ core/data/: 4 module(s)
â”‚  â”œâ”€ core/external/: 2 module(s)
â”‚  â”œâ”€ core/infrastructure/: 2 module(s)
â”‚  â”œâ”€ core/labels/: 2 module(s)
â”‚  â”œâ”€ core/parts/: 3 module(s)
â”‚  â”œâ”€ core/state/: 2 module(s)
â”‚
â””â”€ DATA STRUCTURE DIMENSIONS

   DataFrame Schemas:
   â”œâ”€ wanted_df: ~3 columns (Part, Color, Quantity_wanted)
   â”œâ”€ collection_df: ~5 columns (Part, Color, Quantity, Location, Second_location)
   â””â”€ merged_df: ~10 columns (includes Available, Quantity_have, Quantity_similar, Replacement_parts)

   Dictionary Structures:
   â”œâ”€ found_counts: {(part, color, location): count}
   â”œâ”€ set_found_counts: {(part, color, set_key): count}
   â”œâ”€ locations_index: {location: [image_urls]}
   â”œâ”€ ba_mapping: {rb_part_number: ba_part_number}
   â”œâ”€ color_lookup: {color_id: {name, rgb, is_trans}}
   â””â”€ sets_inventories_cache: {set_number: {set_number, set_name, parts, total_parts}}

================================================================================
STATISTICS SUMMARY
================================================================================
Total Functions: 164
Total Classes: 11
Session State Keys: 18
Modules Analyzed: 23