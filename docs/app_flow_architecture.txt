================================================================================
APPLICATION EXECUTION FLOW
================================================================================

â”Œâ”€ app.py (Main Entry Point)
â”‚
â”œâ”€â”¬â”€ CORE MODULES
â”‚ â”œâ”€ core/auth.py
â”‚     â””â”€ __init__(self, config_path, audit_log_dir)
â”‚     â””â”€ _create_default_config(self)
â”‚     â””â”€ check_session_timeout(self, username)
â”‚ â”œâ”€ core/color_similarity.py
â”‚     â””â”€ rgb_to_lab(rgb_hex)
â”‚     â””â”€ calculate_color_distance(color1_rgb, color2_rgb, is_trans1, ...)
â”‚     â””â”€ build_color_similarity_matrix(colors_df)
â”‚ â”œâ”€ core/colors.py
â”‚     â””â”€ load_colors(colors_path)
â”‚     â””â”€ build_color_lookup(colors_df)
â”‚     â””â”€ render_color_cell(color_id, color_lookup)
â”‚ â”œâ”€ core/download_helpers.py
â”‚     â””â”€ create_download_callbacks(stop_flag_key, show_stats, stats_formatter)
â”‚     â””â”€ __init__(self, stop_flag_key, show_stats, ...)
â”‚     â””â”€ progress_callback(self, message, status)
â”‚ â”œâ”€ core/images.py
â”‚     â””â”€ precompute_location_images(collection_df_serialized, ba_mapping, cache_images_dir, ...)
â”‚     â””â”€ fetch_image_bytes(url, _session)
â”‚     â””â”€ _fetch_single_image(identifier, cache_dir, session)
â”‚ â”œâ”€ core/labels.py
â”‚     â””â”€ organize_labels_by_location(collection_df, ba_mapping, labels_source_dir, ...)
â”‚     â””â”€ generate_collection_labels_zip(collection_files_stream, ba_mapping, labels_source_dir, ...)
â”‚ â”œâ”€ core/lbx_merger.py
â”‚     â””â”€ main()
â”‚     â””â”€ __init__(self, max_length_mm, spacing_mm)
â”‚     â””â”€ parse_label_xml(self, xml)
â”‚ â”œâ”€ core/mapping.py
â”‚     â””â”€ read_ba_mapping_from_excel_bytes(excel_bytes)
â”‚     â””â”€ load_ba_part_names(mapping_path)
â”‚     â””â”€ load_ba_mapping(mapping_path)
â”‚ â”œâ”€ core/paths.py
â”‚     â””â”€ init_paths()
â”‚     â””â”€ save_uploadedfiles(uploadedfiles_list, user_collection_dir)
â”‚     â””â”€ manage_default_collection(user_collection_dir)
â”‚ â”œâ”€ core/preprocess.py
â”‚     â””â”€ sanitize_and_validate(df, required, label)
â”‚     â””â”€ load_wanted_files(files)
â”‚     â””â”€ load_collection_files(files)
â”‚ â””â”€ core/security.py
      â””â”€ _detect_image_type(file_bytes)
      â””â”€ setup_audit_logger(log_dir)
      â””â”€ sanitize_html(text)
â”‚
â”œâ”€â”¬â”€ UI MODULES
â”‚ â”œâ”€ ui/layout.py
â”‚     â””â”€ ensure_session_state_keys()
â”‚     â””â”€ short_key()
â”‚ â”œâ”€ ui/shared_content.py
â”‚     â””â”€ render_about_info_content()
â”‚     â””â”€ render_app_features_content()
â”‚     â””â”€ render_new_user_content()
â”‚ â”œâ”€ ui/summary.py
â”‚     â””â”€ render_summary_table(merged_df)
â”‚ â””â”€ ui/theme.py
      â””â”€ apply_custom_styles()
â”‚
â”œâ”€â”¬â”€ PAGES
â”‚ â”œâ”€ pages/1_Rebrickable_Storage.py
â”‚     â””â”€ 47 lines of code
â”‚ â”œâ”€ pages/2_My_Collection.py
â”‚     â””â”€ 164 lines of code
â”‚ â””â”€ pages/3_Find_Wanted_Parts.py
      â””â”€ 389 lines of code
â”‚
â””â”€â”¬â”€ RESOURCES
  â”œâ”€ auth_config.yaml (User credentials)
  â”œâ”€ colors.csv (LEGO color database)
  â””â”€ part number mapping.xlsx (BA â†” RB)

================================================================================
USER EXPERIENCE FLOW
================================================================================

â”Œâ”€ 1. LOGIN
â”‚  â”œâ”€ User enters credentials
â”‚  â”œâ”€ AuthManager.login() validates
â”‚  â”œâ”€ Session initialized
â”‚  â””â”€ Redirect to main app
â”‚
â–¼
â”‚
â”Œâ”€ 2. UPLOAD WANTED PARTS
â”‚  â”œâ”€ File uploader widget
â”‚  â”œâ”€ CSV validation
â”‚  â”œâ”€ Store in session_state['wanted_df']
â”‚  â””â”€ Display preview
â”‚
â–¼
â”‚
â”Œâ”€ 3. SELECT COLLECTION
â”‚  â”œâ”€ List available collection files
â”‚  â”œâ”€ User selects files
â”‚  â”œâ”€ Load CSVs into session_state['collection_df']
â”‚  â””â”€ Merge collections
â”‚
â–¼
â”‚
â”Œâ”€ 4. PROCESS & MATCH
â”‚  â”œâ”€ preprocess.merge_wanted_collection()
â”‚  â”œâ”€ mapping.apply_part_mappings()
â”‚  â”œâ”€ images.fetch_images()
â”‚  â”œâ”€ colors.add_color_data()
â”‚  â””â”€ Group by location
â”‚
â–¼
â”‚
â”Œâ”€ 5. BROWSE LOCATIONS
â”‚  â”œâ”€ Display location cards
â”‚  â”œâ”€ Show part images
â”‚  â”œâ”€ Display quantities needed/available
â”‚  â””â”€ Expandable details
â”‚
â–¼
â”‚
â”Œâ”€ 6. MARK FOUND PARTS
â”‚  â”œâ”€ User clicks 'Found' button
â”‚  â”œâ”€ Update session_state['found_counts']
â”‚  â”œâ”€ Recalculate remaining
â”‚  â””â”€ Visual feedback
â”‚
â–¼
â”‚
â”Œâ”€ 7. EXPORT RESULTS
â”‚  â”œâ”€ Download merged CSV
â”‚  â”œâ”€ Generate location labels
â”‚  â”œâ”€ Create LBX file
â”‚  â””â”€ Save session progress
â”‚

================================================================================
MULTI-PAGE NAVIGATION STRUCTURE
================================================================================

â”Œâ”€ app.py (Main Entry Point)
â”‚
â”œâ”€ Authentication & Setup
â”‚  â”œâ”€ Login/Register
â”‚  â”œâ”€ Session State Initialization
â”‚  â””â”€ Path Resolution
â”‚
â”œâ”€ Sidebar Features (Global)
â”‚  â”œâ”€ User Profile & Logout
â”‚  â”œâ”€ Get Latest Labels/Images from BrickArchitect
â”‚  â””â”€ Sync Latest Parts Mappings
â”‚
â””â”€â”¬â”€ MULTI-PAGE NAVIGATION
  â”‚
  â”œâ”€ 1_Rebrickable_Storage
  â”‚    â””â”€ 1_Rebrickable_Storage
  â”‚       â”œâ”€ 47 lines of code
  â”‚       â”œâ”€ 1 core module imports
  â”‚       â””â”€ 4 UI elements
  â”œâ”€ 2_My_Collection
  â”‚    â””â”€ ğŸ·ï¸ My Collection
  â”‚       â”œâ”€ 164 lines of code
  â”‚       â”œâ”€ 6 core module imports
  â”‚       â””â”€ 12 UI elements
  â””â”€ 3_Find_Wanted_Parts
       â””â”€ ğŸ” Find Wanted Parts
          â”œâ”€ 389 lines of code
          â”œâ”€ 9 core module imports
          â””â”€ 22 UI elements

================================================================================
PAGE NAVIGATION FLOW
================================================================================

â”Œâ”€ 1. Landing Page (app.py)
â”‚  â”œâ”€ User logs in or registers
â”‚  â”œâ”€ Sees welcome screen with navigation options
â”‚  â””â”€ Can access sidebar features (labels, images, mappings)
â”‚
â–¼
â”‚
â”Œâ”€ 2. Rebrickable Storage (1_Rebrickable_Storage.py)
â”‚  â”œâ”€ Main dashboard and getting started page
â”‚  â”œâ”€ Overview of available functions
â”‚  â”œâ”€ Navigation to other pages
â”‚  â””â”€ Change password functionality
â”‚
â–¼
â”‚
â”Œâ”€ 3. My Collection (2_My_Collection.py)
â”‚  â”œâ”€ Manage collection files (upload, select, delete)
â”‚  â”œâ”€ Generate printable labels by location
â”‚  â”œâ”€ Manage custom part images
â”‚  â””â”€ View collection statistics
â”‚
â–¼
â”‚
â”Œâ”€ 4. Find Wanted Parts (3_Find_Wanted_Parts.py)
â”‚  â”œâ”€ Upload wanted parts lists
â”‚  â”œâ”€ Select collection files to search
â”‚  â”œâ”€ Precompute collection images
â”‚  â”œâ”€ Generate pickup list by location
â”‚  â”œâ”€ Mark parts as found
â”‚  â”œâ”€ View color alternatives
â”‚  â”œâ”€ Save/load progress
â”‚  â””â”€ Download merged results
â”‚

================================================================================
FUNCTION DISTRIBUTION ANALYSIS
================================================================================

â”Œâ”€ FUNCTION DISTRIBUTION BY MODULE TYPE
â”‚
â”‚  Core Modules:      0 functions
â”‚  UI Modules:        0 functions
â”‚  Resource Modules:  0 functions
â”‚  Main App:          0 functions
â”‚
â”œâ”€ PAGE COMPLEXITY METRICS
â”‚
â”‚  â”œâ”€ 1_Rebrickable_Storage
â”‚  â”‚     â”œâ”€ 47 lines of code
â”‚  â”‚     â”œâ”€ 1 core module imports
â”‚  â”‚     â””â”€ 4 UI elements
â”‚  â”œâ”€ 2_My_Collection
â”‚  â”‚     â”œâ”€ 164 lines of code
â”‚  â”‚     â”œâ”€ 6 core module imports
â”‚  â”‚     â””â”€ 12 UI elements
â”‚  â””â”€ 3_Find_Wanted_Parts
â”‚        â”œâ”€ 389 lines of code
â”‚        â”œâ”€ 9 core module imports
â”‚        â””â”€ 22 UI elements
â”‚
â””â”€ ARCHITECTURE PATTERN

   The application follows a modular architecture:
   â”œâ”€ Core modules contain business logic (reusable)
   â”œâ”€ UI modules contain presentation helpers (reusable)
   â”œâ”€ Pages contain page-specific UI logic (minimal functions)
   â””â”€ Main app handles authentication and global setup

   This separation ensures:
   â€¢ Business logic is testable and reusable
   â€¢ Pages remain focused on user interaction
   â€¢ Code is maintainable and scalable

================================================================================
DATA STRUCTURES & DIMENSIONS
================================================================================

â”Œâ”€ SESSION STATE (st.session_state)
â”‚
â”‚  â”œâ”€ wanted_df: DataFrame
â”‚  â”‚     â””â”€ Wanted parts list
â”‚  â”‚        â””â”€ Columns: Part, Color, Quantity, Location
â”‚  â”œâ”€ collection_df: DataFrame
â”‚  â”‚     â””â”€ User's collection
â”‚  â”‚        â””â”€ Columns: Part, Color, Quantity, Location
â”‚  â”œâ”€ merged_df: DataFrame
â”‚  â”‚     â””â”€ Matched parts
â”‚  â”‚        â””â”€ wanted_df + collection_df merged
â”‚  â”œâ”€ found_counts: Dict
â”‚  â”‚     â””â”€ Tracking found parts
â”‚  â”‚        â””â”€ {(part, color, location): count}
â”‚  â”œâ”€ locations_index: Dict
â”‚  â”‚     â””â”€ Location grouping
â”‚  â”‚        â””â”€ {location: [image_urls]}
â”‚  â”œâ”€ expanded_loc: str
â”‚  â”‚     â””â”€ UI state
â”‚  â”‚        â””â”€ Currently expanded location
â”‚  â”œâ”€ start_processing: bool
â”‚  â”‚     â””â”€ Trigger flag
â”‚  â”‚        â””â”€ Initiates processing
â”‚  â””â”€ theme: str
â”‚        â””â”€ UI preference
â”‚           â””â”€ 'dark' or 'light'
â”‚
â”œâ”€ DATAFRAMES
â”‚
â”‚  â”œâ”€ wanted_df
â”‚  â”‚     â”œâ”€ Part Number (str)
â”‚  â”‚     â”œâ”€ Color (str)
â”‚  â”‚     â”œâ”€ Quantity Needed (int)
â”‚  â”‚     â””â”€ Location (str, optional)
â”‚  â”œâ”€ collection_df
â”‚  â”‚     â”œâ”€ Part Number (str)
â”‚  â”‚     â”œâ”€ Color (str)
â”‚  â”‚     â”œâ”€ Quantity Available (int)
â”‚  â”‚     â””â”€ Location (str)
â”‚  â””â”€ merged_df
â”‚        â”œâ”€ Part Number (str)
â”‚        â”œâ”€ Color (str)
â”‚        â”œâ”€ Quantity Needed (int)
â”‚        â”œâ”€ Quantity Available (int)
â”‚        â”œâ”€ Location (str)
â”‚        â”œâ”€ Image URL (str)
â”‚        â”œâ”€ Color Name (str)
â”‚        â””â”€ Color RGB (str)
â”‚
â””â”€ FILE SYSTEM

   â”œâ”€ user_data/{username}/
   â”‚     â”œâ”€ collection/*.csv - User's collection files
   â”‚     â””â”€ session_data.json - Saved progress
   â”œâ”€ cache/
   â”‚     â”œâ”€ images/*.png - Cached part images
   â”‚     â””â”€ labels/*.png - Generated label images
   â””â”€ resources/
         â”œâ”€ auth_config.yaml - User credentials (hashed)
         â”œâ”€ colors.csv - LEGO color database (~200 colors)
         â””â”€ part number mapping.xlsx - BAâ†”RB mappings (~2000 parts)

================================================================================
MODULE DEPENDENCIES
================================================================================

app.py
â”‚
â”œâ”€ core.auth
â”‚    â””â”€ â†’ core.paths
â”œâ”€ core.preprocess
â”‚    â”œâ”€ â†’ core.mapping
â”‚    â””â”€ â†’ core.paths
â”œâ”€ core.images
â”‚    â””â”€ â†’ core.paths
â”œâ”€ core.labels
â”‚    â”œâ”€ â†’ core.paths
â”‚    â””â”€ â†’ core.images
â”œâ”€ core.lbx_merger
â”‚    â””â”€ â†’ core.paths
â”œâ”€ ui.layout
â”œâ”€ ui.summary
â”‚    â””â”€ â†’ core.colors
â””â”€ ui.theme

================================================================================
ARCHITECTURE OVERVIEW
================================================================================

â”Œâ”€ TECHNOLOGY STACK
â”‚
â”‚  Frontend
â”‚  â””â”€ Streamlit (Web UI Framework)
â”‚
â”‚  Authentication
â”‚  â”œâ”€ streamlit-authenticator (Auth library)
â”‚  â”œâ”€ bcrypt (Password hashing)
â”‚  â””â”€ PyYAML (Config management)
â”‚
â”‚  Data Processing
â”‚  â”œâ”€ pandas (Data manipulation)
â”‚  â””â”€ requests (HTTP client)
â”‚
â”‚  Storage
â”‚  â”œâ”€ Local filesystem (Development)
â”‚  â””â”€ JSON (Session serialization)
â”‚
â”œâ”€ SESSION STATE MANAGEMENT
â”‚
â”‚  Global (Shared)
â”‚  â”œâ”€ ba_mapping - Part number mappings
â”‚  â”œâ”€ color_lookup - Color database
â”‚  â””â”€ theme - UI theme preference
â”‚
â”‚  User-Specific (Isolated)
â”‚  â”œâ”€ username - Current user
â”‚  â”œâ”€ authenticated - Auth status
â”‚  â”œâ”€ collection_df - User's collection
â”‚  â”œâ”€ found_counts - Parts marked as found
â”‚  â”œâ”€ locations_index - Location grouping
â”‚  â””â”€ merged_df - Matched parts
â”‚
â”œâ”€ EXTERNAL INTEGRATIONS
â”‚
â”‚  â”Œâ”€ Rebrickable API
â”‚  â”‚  â””â”€ Part data and mappings
â”‚  â”‚
â”‚  â””â”€ BrickArchitect Images
â”‚     â””â”€ Part images (cached locally)
â”‚
â””â”€ DEPLOYMENT

   Development:
   â”œâ”€ localhost:8501
   â”œâ”€ File-based storage
   â”œâ”€ Local user_data/
   â””â”€ YAML configuration

   Production (Recommended):
   â”œâ”€ HTTPS with SSL/TLS
   â”œâ”€ Database backend (PostgreSQL/MongoDB)
   â”œâ”€ Cloud storage (S3/Azure Blob)
   â””â”€ Environment secrets management

================================================================================
RUNTIME METRICS & DATA DIMENSIONS
================================================================================

â”Œâ”€ RESOURCE DATA
â”‚
â”‚  Colors Database:
â”‚  â”œâ”€ Rows: 273
â”‚  â””â”€ Columns: 8
â”‚
â”‚  Part Mappings (BA â†” RB):
â”‚  â”œâ”€ Rows: 4342
â”‚  â””â”€ Columns: 14
â”‚
â””â”€ DATA STRUCTURE DIMENSIONS

   DataFrame Schemas:
   â”œâ”€ wanted_df: ~4-5 columns (Part, Color, Quantity, Location)
   â”œâ”€ collection_df: ~4 columns (Part, Color, Quantity, Location)
   â””â”€ merged_df: ~8-10 columns (includes Image URL, Color data)

   Dictionary Structures:
   â”œâ”€ found_counts: {(part, color, location): count}
   â”œâ”€ locations_index: {location: [image_urls]}
   â”œâ”€ ba_mapping: {ba_part_number: rb_part_number}
   â””â”€ color_lookup: {color_id: {name, rgb, ...}}

================================================================================
STATISTICS SUMMARY
================================================================================
Total Functions: 112
Total Classes: 6
Session State Keys: 10
Modules Analyzed: 18